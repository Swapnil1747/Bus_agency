{% extends "base.html" %}

{% block title %}My Bookings - SwiftBus{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">My Bookings</h2>
        {% if bookings %}
            {% for booking in bookings %}
                <div class="ticket-card mb-4 p-4 rounded shadow" style="background: linear-gradient(135deg, #1e3a8a, #223366); color: #f3f6fa;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h4 class="fw-bold mb-1">{{ booking.route.bus.model }}</h4>
                            <div>{{ booking.route.origin }} → {{ booking.route.destination }}</div>
                        </div>
                        <div>
                            <span class="badge bg-success fs-6">{{ booking.status|title }}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div><strong>Departure:</strong> {{ booking.route.departure_time.strftime('%Y-%m-%d %H:%M') }}</div>
                            <div><strong>Arrival:</strong> {{ booking.route.arrival_time.strftime('%Y-%m-%d %H:%M') }}</div>
                            <div><strong>Seat Number:</strong> {{ booking.seat_number }}</div>
                            <div><strong>Number of Persons:</strong> {{ booking.num_persons }}</div>
                            <div><strong>Total Fare:</strong> ₹{{ '%.2f'|format(booking.route.price * booking.num_persons) }}</div>
                            <div><strong>Booking Date:</strong> {{ booking.booking_date.strftime('%Y-%m-%d %H:%M') }}</div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{{ url_for('main.ticket_pdf', booking_id=booking.id) }}" class="btn btn-outline-light mb-2" target="_blank">Download PDF Ticket</a>
                            {% if booking.status == 'confirmed' %}
                                <form action="{{ url_for('main.cancel_booking', booking_id=booking.id) }}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to cancel this booking?')">
                                        Cancel Booking
                                    </button>
                                </form>
                            {% elif booking.status == 'cancelled' %}
                                <form action="{{ url_for('main.delete_booking', booking_id=booking.id) }}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to permanently delete this booking?')">
                                        Delete
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
            <div class="alert alert-success text-end fs-5">
                <div><strong>Total Tickets:</strong> {{ total_tickets }}</div>
                <div><strong>Fare per Ticket:</strong> ₹{{ '%.2f'|format(average_fare) }}</div>
                <div><strong>Total Spent:</strong> ₹{{ '%.2f'|format(total_spent) }}</div>
            </div>
        {% else %}
            <div class="alert alert-info">
                You haven't made any bookings yet. <a href="{{ url_for('main.search') }}">Search for buses</a> to make your first booking!
            </div>
        {% endif %}
        {% if all_confirmed %}
            <form action="{{ url_for('main.clear_history') }}" method="post" class="mb-3 text-end">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to clear your entire confirmed ticket history?')">
                    Clear History
                </button>
            </form>
            <h3 class="mt-3 mb-3">All Confirmed Tickets (Full History)</h3>
            {% for booking in all_confirmed %}
                <div class="ticket-card mb-3 p-3 rounded shadow" style="background: #1e3a8a; color: #f3f6fa;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h5 class="fw-bold mb-1">{{ booking.route.bus.model }}</h5>
                            <div>{{ booking.route.origin }} → {{ booking.route.destination }}</div>
                        </div>
                        <span class="badge bg-success fs-6">{{ booking.status|title }}</span>
                    </div>
                    <div>
                        <div><strong>Departure:</strong> {{ booking.route.departure_time.strftime('%Y-%m-%d %H:%M') }}</div>
                        <div><strong>Seat Number:</strong> {{ booking.seat_number }}</div>
                        <div><strong>Total Fare:</strong> ₹{{ '%.2f'|format(booking.route.price * booking.num_persons) }}</div>
                        <div><strong>Booking Date:</strong> {{ booking.booking_date.strftime('%Y-%m-%d %H:%M') }}</div>
                        <div class="mt-2 text-end">
                            {% if booking.status == 'confirmed' %}
                                <form action="{{ url_for('main.cancel_booking', booking_id=booking.id) }}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to cancel this booking?')">
                                        Cancel Booking
                                    </button>
                                </form>
                            {% elif booking.status == 'cancelled' %}
                                <form action="{{ url_for('main.delete_booking', booking_id=booking.id) }}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to permanently delete this booking?')">
                                        Delete
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>
{% endblock %} 