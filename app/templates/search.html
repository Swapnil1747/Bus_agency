{% extends "base.html" %}

{% block title %}Search Buses - SwiftBus{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <div class="row mb-5">
        <div class="col-md-12 text-center">
            <h1 class="display-4 mb-3">Find Your Perfect Bus Journey</h1>
            <p class="lead text-muted">Search from thousands of bus routes across the country</p>
        </div>
    </div>

    <!-- Search Form -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="search-form fade-in">
                <form id="searchForm" method="GET" action="{{ url_for('main.search') }}" class="needs-validation" novalidate>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="origin" class="form-label">From</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                <input type="text" class="form-control" id="origin" name="origin" 
                                       placeholder="Enter city" required value="{{ request.args.get('origin', '') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="destination" class="form-label">To</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                <input type="text" class="form-control" id="destination" name="destination" 
                                       placeholder="Enter city" required value="{{ request.args.get('destination', '') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="date" class="form-label">Date of Journey</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                <input type="date" class="form-control" id="date" name="date" 
                                       required value="{{ request.args.get('date', '') }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="passengers" class="form-label">Number of Passengers</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-users"></i></span>
                                <input type="number" class="form-control" id="passengers" name="passengers" 
                                       min="1" max="10" value="{{ request.args.get('passengers', '1') }}">
                            </div>
                        </div>
                        <div class="col-12 text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-search"></i> Search Buses
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bus Results (move this above Popular Routes) -->
    <div id="bus-results" class="mt-4"></div>

    <!-- Popular Routes -->
    <div class="row mt-5">
        <div class="col-md-12">
            <h2 class="text-center mb-4">Popular Routes</h2>
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Mumbai - Pune</h5>
                            <p class="card-text text-muted">Frequent buses available</p>
                            <a href="{{ url_for('main.search', origin='Mumbai', destination='Pune') }}" 
                               class="btn btn-outline-primary">Search Now</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Delhi - Jaipur</h5>
                            <p class="card-text text-muted">Luxury buses available</p>
                            <a href="{{ url_for('main.search', origin='Delhi', destination='Jaipur') }}" 
                               class="btn btn-outline-primary">Search Now</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Bangalore - Chennai</h5>
                            <p class="card-text text-muted">Express services available</p>
                            <a href="{{ url_for('main.search', origin='Bangalore', destination='Chennai') }}" 
                               class="btn btn-outline-primary">Search Now</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.feedback-card-dark {
    background: linear-gradient(135deg, #232b4a 0%, #181f3a 100%);
    color: #f3f6fa;
    border-radius: 1.5rem;
    box-shadow: 0 4px 32px 0 #0d6efd22;
    padding: 2rem 2rem 1.5rem 2rem;
    margin: 2rem 0;
    border: 1.5px solid #223366;
}
.feedback-card-dark h3 {
    color: #4fc3f7;
    font-weight: 700;
    font-size: 1.6rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.feedback-card-dark label {
    color: #b0b8d1;
    font-weight: 600;
    margin-bottom: 0.5rem;
}
.feedback-card-dark textarea {
    background: #1a2236;
    color: #f3f6fa;
    border: 2px solid #223366;
    border-radius: 0.8rem;
    min-height: 120px;
    font-size: 1.1rem;
    padding: 1rem;
    margin-bottom: 1.2rem;
    transition: border 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px #0d6efd11;
}
.feedback-card-dark textarea:focus {
    border: 2px solid #4fc3f7;
    outline: none;
    box-shadow: 0 0 0 2px #4fc3f755;
}
.feedback-card-dark .btn-feedback {
    background: linear-gradient(90deg, #ff9800 0%, #ffb74d 100%);
    color: #181f3a;
    font-weight: 700;
    border: none;
    border-radius: 0.7rem;
    padding: 0.7rem 2.2rem;
    font-size: 1.1rem;
    box-shadow: 0 2px 8px #ff980033;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
}
.feedback-card-dark .btn-feedback:hover, .feedback-card-dark .btn-feedback:focus {
    background: linear-gradient(90deg, #ffb74d 0%, #ff9800 100%);
    color: #181f3a;
    box-shadow: 0 4px 16px #ff980055;
}
</style>

<!-- Feedback Section -->
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-sm-12 col-md-10 col-lg-8 mx-auto">
      <div class="feedback-card-dark">
        <h3><i class="bi bi-chat-dots"></i> We value your feedback!</h3>
        <form id="feedbackForm" method="POST" action="{{ url_for('main.submit_feedback') }}">
          <label for="feedback" class="form-label">Your Feedback</label>
          <textarea class="form-control" id="feedback" name="feedback" rows="3" required placeholder="Share your experience or suggestions..."></textarea>
          <button type="submit" class="btn btn-feedback mt-3">Submit Feedback</button>
          <div id="feedbackSuccess" class="alert alert-success mt-3 d-none" role="alert">
            Thank you for your feedback!
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to today
    const dateInput = document.getElementById('date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;

    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });

    // Pre-fill form from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('origin')) {
        document.getElementById('origin').value = urlParams.get('origin');
    }
    if (urlParams.has('destination')) {
        document.getElementById('destination').value = urlParams.get('destination');
    }
    if (urlParams.has('date')) {
        document.getElementById('date').value = urlParams.get('date');
    }
    if (urlParams.has('passengers')) {
        document.getElementById('passengers').value = urlParams.get('passengers');
    }
});

document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    const date = document.getElementById('date').value;
    const passengers = document.getElementById('passengers').value;

    fetch(`/api/search_buses?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&date=${encodeURIComponent(date)}&passengers=${encodeURIComponent(passengers)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('bus-results');
            if (data.buses.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">No buses found.</div>';
            } else {
                resultsDiv.innerHTML = data.buses.map(bus => `
                    <div class="bus-result-row d-flex justify-content-between align-items-center py-3 border-bottom">
                        <div>
                            <h5 class="mb-1">${bus.bus_name}</h5>
                            <div>Departure: ${bus.departure_time}</div>
                            <div>Fare: ₹${bus.fare}</div>
                            <div>Available Seats: ${bus.available_seats}</div>
                            <div class="fw-bold" style="color: #22c55e; font-size: 1.3rem;">Total for ${passengers} passenger${passengers > 1 ? 's' : ''}: ₹${(bus.fare * passengers).toFixed(2)}</div>
                        </div>
                        <a href="/book/${bus.id}" class="btn btn-primary">Book Now</a>
                    </div>
                `).join('');
            }
        });
});
</script>
{% endblock %} 